<!-- partials/config.html -->
<style>
  .config-panel {
    font-family: "Segoe UI", sans-serif;
    max-width: 600px;
    margin: 40px auto;
    background: #ffffff;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
  }

  .config-panel h2 {
    font-size: 22px;
    margin-bottom: 25px;
    color: #2c3e50;
    border-left: 5px solid #007acc;
    padding-left: 10px;
  }

  .config-panel label {
    display: block;
    font-weight: 600;
    margin-bottom: 6px;
    color: #444;
  }

  .config-panel select,
  .config-panel input[type="text"] {
    width: 100%;
    padding: 10px 12px;
    margin-bottom: 20px;
    font-size: 15px;
    border: 1px solid #ccc;
    border-radius: 6px;
    background-color: #fdfdfd;
  }

  .config-panel select:focus,
  .config-panel input:focus {
    border-color: #007acc;
    outline: none;
  }

  .config-panel button {
    background-color: #007acc;
    color: #fff;
    border: none;
    padding: 12px 16px;
    font-size: 16px;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.2s ease-in-out;
    width: 100%;
  }

  .config-panel button:hover {
    background-color: #005fa3;
  }
</style>

<div class="config-panel">
  <h2>AI Provider Configuration</h2>

  <form id="ai-config-form">
    <label for="provider-select">Provider:</label>
    <select id="provider-select" name="provider" onchange="updateModelOptions()">
      {% for provider in available_providers %}
      <option value="{{ provider }}" {% if ai_config.provider == provider %}selected{% endif %}>{{ provider }}</option>
      {% endfor %}
    </select>

    <label for="model-select">Model:</label>
    <select id="model-select" name="model">
      <option value="{{ ai_config.model or '' }}" selected hidden>{{ ai_config.model or 'Select model' }}</option>
    </select>

    <label for="api-key-input">API Key:</label>
    <input type="text" id="api-key-input" name="api_key" value="{{ ai_config.api_key or '' }}">

    <button type="submit">Save Configuration</button>
  </form>
</div>


<script>
  async function updateModelOptions() {
    const provider = document.getElementById("provider-select").value;
    const modelSelect = document.getElementById("model-select");

    // Clear previous models
    modelSelect.innerHTML = `<option disabled selected>Loading models...</option>`;

    try {
      const response = await fetch(`/api/models/${provider.toLowerCase()}`);
      if (!response.ok) throw new Error("Model list fetch failed");

      const models = await response.json();

      modelSelect.innerHTML = "";

      if (Array.isArray(models) && models.length > 0) {
        models.forEach((model) => {
          const option = document.createElement("option");
          option.value = model;
          option.textContent = model;
          modelSelect.appendChild(option);
        });
      } else {
        modelSelect.innerHTML = `<option disabled>No models available</option>`;
      }
    } catch (err) {
      console.error("Error loading models:", err);
      modelSelect.innerHTML = `<option disabled>Error loading models</option>`;
    }
  }

  document.getElementById('ai-config-form').addEventListener('submit', function(event) {
    event.preventDefault();
    const provider = document.getElementById('provider-select').value;
    const model = document.getElementById('model-select').value;
    const apiKey = document.getElementById('api-key-input').value;

    fetch('/api/config', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ provider, model, api_key: apiKey })
    })
    .then(res => res.json())
    .then(data => {
      alert(data.message || data.error || 'Unexpected response');
      loadSection('config');
    })
    .catch(error => console.error('Error saving configuration:', error));
  });

  // Load models immediately on first load
  updateModelOptions();
</script>
